name: Dependabot
on:
    workflow_dispatch: {}
    schedule:
        # random HH:MM to avoid a load spike on GitHub Actions at 00:00
        - cron: 34 2 * * *
permissions:
    contents: write
jobs:
    merge_prs:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v2
            - name: Merge PRs
              run: |
                  # Merge all Dependabot PRs that were created more than a week ago and have all checks passing
                  for pr in `gh pr list --json number,author,createdAt --search "created:<=$(date -d "1 day ago" +"%Y-%m-%d") author:app/dependabot status:success" --jq '.[].number'`; do
                      gh pr merge --auto --squash "$pr"
                  done
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
