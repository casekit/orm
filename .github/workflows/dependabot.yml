name: Dependabot
on:
    workflow_dispatch: {}
    schedule:
        # random HH:MM to avoid a load spike on GitHub Actions at 00:00
        - cron: 34 2 * * *
permissions:
    contents: write
    statuses: read
    checks: read
jobs:
    merge_prs:
        name: "Merge PRs > 1 week old"
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Merge PRs
              run: |
                  set -e
                  # Merge all Dependabot PRs that were created more than a week ago and have all checks passing
                  for pr in `gh pr list --json number,author,createdAt --search "created:<=$(date -d "7 days ago" +"%Y-%m-%d") author:app/dependabot status:success" --jq '.[].number'`; do
                      gh pr merge --squash "$pr"
                  done
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
