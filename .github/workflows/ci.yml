name: CI
env:
    DO_NOT_TRACK: 1

on:
    push:
        branches: [main]
        paths:
            - "packages/**"
    pull_request:
        branches: [main]
        paths:
            - "packages/**"

jobs:
    build:
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres:latest
                env:
                    POSTGRES_USER: orm
                    POSTGRES_PASSWORD: password
                    POSTGRES_DB: orm
                ports:
                    - 54321:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v6

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  run_install: false

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version-file: ".tool-versions"
                  cache: "pnpm"

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run tests
              run: pnpm test

            - name: Check formatting
              run: pnpm format:check

            - name: Lint
              run: pnpm lint

            - name: Check dependencies are in sync
              run: pnpm syncpack:check

            - name: Check types
              run: pnpm typecheck

            - name: Upload coverage reports
              if: github.actor != 'dependabot[bot]'
              uses: actions/upload-artifact@v6
              with:
                  name: coverage-reports
                  path: |
                      packages/*/coverage
                  retention-days: 7

            - name: Extract coverage percentage
              id: coverage
              if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
              shell: bash
              run: |
                  echo "coverage<<EOF" >> $GITHUB_OUTPUT
                  for d in packages/*/coverage/coverage-summary.json; do
                    pkg=$(echo $d | cut -d'/' -f2)
                    pct=$(jq -r '.total.lines.pct' $d)
                    echo "* $pkg: ${pct}%" >> $GITHUB_OUTPUT
                  done
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Find Comment
              uses: peter-evans/find-comment@v4
              if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
              id: find-comment
              with:
                  issue-number: ${{ github.event.pull_request.number }}
                  comment-author: "github-actions[bot]"
                  body-includes: "Coverage Report"

            - name: Create or Update Comment
              uses: peter-evans/create-or-update-comment@v5
              if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
              with:
                  comment-id: ${{ steps.find-comment.outputs.comment-id }}
                  issue-number: ${{ github.event.pull_request.number }}
                  body: |
                      ### Coverage Report
                      ${{ steps.coverage.outputs.coverage }}
                  edit-mode: replace
